<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>push-all-in-cloud 配置生成器</title>
    <!--  引入Vue 3的CDN -->
    <script src="https://unpkg.com/vue@3.5.13/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.8.8/dist/index.css" />
    <!-- 引入Element Plus的CDN -->
    <script src="https://unpkg.com/element-plus@2.8.8/dist/index.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@smallwei/avue@3.5.6/lib/index.css">
    <!-- 引入Avue的CDN -->
    <script src="https://unpkg.com/@smallwei/avue@3.5.6/lib/avue.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.10.0/styles/dark.min.css">
    <!-- 引入highlight.js的CDN -->
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.10.0/highlight.min.js"></script>
    <!-- 引入highlight.js的JavaScript语言支持 -->
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.10.0/languages/javascript.min.js"></script>

    <script src="https://unpkg.com/@highlightjs/vue-plugin@2.1.0/dist/highlightjs-vue.min.js"></script>
</head>

<body>
    <div id="app">
        <p>push-all-in-one 和 push-all-in-cloud 通用配置生成器</p>
        <el-tabs v-model="type" class="demo-tabs">
            <template v-for="item in options">
                <el-tab-pane :label="item.namespace" :name="item.name">
                    <div style="display: flex;">
                        <div style="width: 50%; padding-right: 20px;">
                            <label>{{item.namespace}}</label>
                            <p>构造函数配置项</p>
                            <avue-form :option="item.avueConfig" v-model="configValues[item.name]"
                                @submit="postForward"></avue-form>
                            <p>附加参数选项</p>
                            <avue-form :option="item.avueOption" v-model="optionValues[item.name]"
                                @submit="postForward"></avue-form>
                        </div>
                        <div style="width: 50%;">
                            <label>配置结果</label>

                            <div>
                                <div style="display: flex; justify-content: space-between;">
                                    <p>构造函数配置项</p>
                                    <span style="margin-top: 11px;">
                                        <el-button type="primary"
                                            @click="copyText(JSON.stringify(configValues[item.name] || {}, null, 4))">复制
                                        </el-button>
                                    </span>
                                </div>
                                <highlightjs language="javascript"
                                    :code="JSON.stringify(configValues[item.name] || {}, null, 4)" />
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between;">
                                    <p>附加参数选项</p>
                                    <span style="margin-top: 11px;">
                                        <el-button type="primary"
                                            @click="copyText(JSON.stringify(optionValues[item.name] || {}, null, 4))">复制
                                        </el-button>
                                    </span>
                                </div>
                                <highlightjs language="javascript"
                                    :code="JSON.stringify(optionValues[item.name] || {}, null, 4)" />
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between;">
                                    <p>推送结果</p>
                                </div>
                                <highlightjs language="javascript" :code="JSON.stringify(response || {}, null, 4)" />
                            </div>
                        </div>
                    </div>
                </el-tab-pane>
            </template>
        </el-tabs>
    </div>

    <script>
        const { ElMessage } = ElementPlus
        async function getOption() {
            return (await (await fetch('/option')).json())?.data?.option || {};
        }

        async function postForward(data) {
            const { title, desp, type, config, option } = data
            return (await (await fetch('/forward', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title,
                    desp,
                    type,
                    config,
                    option
                })
            }).then(res => {
                if (res.ok) {
                    return res.json()
                }
                return Promise.reject(res)// reject promise if HTTP error
            })))?.data || {};
        }

        function copyText(text) {
            AVUE.$Clipboard({
                text
            }).then(() => {
                ElMessage.success('复制成功')
            }).catch(() => {
                ElMessage.error('复制失败')
            });
        }

        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    type: '',
                    configValues: {},
                    optionValues: {},
                    options: {},
                    response: {}
                };
            },
            methods: {
                async getOption() {
                    const option = await getOption();
                    // console.log(option)
                    this.options = option;
                    this.type = Object.keys(option)?.[0];
                },
                copyText,
                async postForward(form, done) {
                    try {
                        const type = this.type
                        const title = 'PushAllInOne 测试推送'
                        const desp = 'PushAllInOne 测试推送 - ' + this.options[type]?.namespace
                        const config = this.configValues[type] || {}
                        const option = this.optionValues[type] || {}
                        const res = await postForward({ title, desp, type, config, option });
                        console.log(res)
                        this.response = res
                        ElMessage.success('推送成功')
                    } catch (error) {
                        console.error(error)
                        ElMessage.error('推送失败')
                    } finally {
                        done()
                    }
                }
            },
            mounted() {
                this.getOption()
            },
        });
        app.use(ElementPlus)
        // 使用Avue插件
        app.use(AVUE);
        app.use(hljsVuePlugin)
        app.mount('#app');
    </script>
</body>

</html>